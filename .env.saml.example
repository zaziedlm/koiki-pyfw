# =============================
# SAML Authentication Configuration - Keycloak Docker設定例
# =============================
# このファイルを .env にコピーして、実際の値に変更してください

# === 必須SAML設定 ===
# Service Provider設定
SAML_SP_ENTITY_ID=http://localhost:8000/api/v1/auth/saml/metadata
SAML_SP_ACS_URL=http://localhost:8000/api/v1/auth/saml/acs
SAML_SP_SLS_URL=http://localhost:8000/api/v1/auth/saml/sls

# Identity Provider設定（Docker Keycloak）
# コンテナ間通信用: keycloak:8080, ブラウザアクセス用: localhost:8090
SAML_IDP_ENTITY_ID=http://localhost:8090/realms/koiki-saml
SAML_IDP_SSO_URL=http://localhost:8090/realms/koiki-saml/protocol/saml
SAML_IDP_SLS_URL=http://localhost:8090/realms/koiki-saml/protocol/saml

# === SAML 証明書取得戦略 ===
# 証明書の取得方法を指定（auto|metadata|static|hybrid）
# - auto: メタデータから取得を試み、失敗時は静的証明書にフォールバック（推奨・デフォルト）
# - metadata: メタデータからのみ取得（OIDC JWKS方式と同様）
# - static: 環境変数の静的証明書のみ使用（レガシー互換）
# - hybrid: 静的証明書で失敗時、メタデータから再取得してリトライ
SAML_CERT_FETCH_STRATEGY=auto

# メタデータURL（auto/metadata/hybrid戦略で必要）
# 重要: Docker環境ではコンテナ間通信用にサービス名を使用
# - Docker内: http://keycloak:8080/realms/koiki-saml/protocol/saml/descriptor
# - ローカル開発: http://localhost:8090/realms/koiki-saml/protocol/saml/descriptor
# - 本番環境: https://idp.example.com/saml/metadata
SAML_IDP_METADATA_URL=http://keycloak:8080/realms/koiki-saml/protocol/saml/descriptor

# メタデータキャッシュTTL（秒）- デフォルト: 3600秒（1時間）
# IdPの証明書更新頻度に応じて調整
SAML_METADATA_CACHE_TTL_SECONDS=3600

# SAML IdP X.509 証明書（静的設定 - static/auto/hybrid戦略で使用）
# 取得方法: http://localhost:8090 > koiki-saml realm > Realm Settings > Keys > RSA256 Certificate
# 注意: auto/metadata戦略の場合、この値は省略可能（メタデータから自動取得）
SAML_IDP_X509_CERT="-----BEGIN CERTIFICATE-----
MIICmzCCAYMCBgGDEkY7KDANBgkqhkiG9w0BAQsFADA...
-----END CERTIFICATE-----"

# SP署名用証明書（オプション - 署名が必要な場合）
SAML_SP_X509_CERT=""
SAML_SP_PRIVATE_KEY=""

# === SAML セキュリティ設定 ===
SAML_SIGN_REQUESTS=false
SAML_SIGN_RESPONSES=true
SAML_SIGN_ASSERTIONS=true
SAML_ENCRYPT_ASSERTIONS=false

# [Required] RelayState署名用シークレット（本番環境では必ず変更）
SAML_RELAY_STATE_SIGNING_KEY=change_me_saml_relay_state_secret_in_production

# === SAML 属性マッピング設定 ===
SAML_ATTRIBUTE_MAPPING='{
  "email": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress",
  "name": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name",
  "given_name": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname",
  "family_name": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname"
}'

# === オプション設定 ===
SAML_AUTO_CREATE_USERS=true
SAML_DEFAULT_PROVIDER=saml
SAML_REQUIRE_EMAIL_VERIFIED=false
SAML_ALLOWED_DOMAINS=""
SAML_DEFAULT_REDIRECT_URI=http://localhost:3000/auth/saml/callback
SAML_ALLOWED_REDIRECT_URIS=http://localhost:3000/auth/saml/callback
SAML_LOGIN_TICKET_TTL_SECONDS=120

# === デバッグ設定（開発環境用） ===
# Debug mode (verbose logging; do not enable in production)
SAML_DEBUG_MODE=true

# Skip SSL verification (development only)
SAML_SKIP_SSL_VERIFY=true

# === SAML セッション設定 ===
SAML_ASSERTION_TTL=300
SAML_CLOCK_SKEW_SECONDS=30
SAML_RELAY_STATE_TTL_SECONDS=600

# === NameID フォーマット ===
SAML_NAME_ID_FORMAT=urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress

# === AuthnContext クラス ===
SAML_AUTHN_CONTEXT_CLASS=urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport



# =============================
# Docker Compose設定用コメント
# =============================
#
# 1. Keycloak Admin Console: http://localhost:8090
#    ログイン: admin / admin
#
# 2. SAML Realm: koiki-saml をインポート
#    docker/keycloak/realm-saml.json を使用
#
# 3. 証明書取得戦略の選択:
#
#    【推奨】auto戦略（メタデータ優先 + 静的証明書フォールバック）:
#      SAML_CERT_FETCH_STRATEGY=auto
#      SAML_IDP_METADATA_URL=http://localhost:8090/realms/koiki-saml/protocol/saml/descriptor
#      SAML_IDP_X509_CERT="..." (フォールバック用)
#      → 証明書ローテーション自動対応、かつ安全性が高い
#
#    metadata戦略（完全動的 - OIDC方式）:
#      SAML_CERT_FETCH_STRATEGY=metadata
#      SAML_IDP_METADATA_URL=http://localhost:8090/realms/koiki-saml/protocol/saml/descriptor
#      SAML_IDP_X509_CERT="" (不要)
#      → メタデータアクセス不可時は認証失敗
#
#    static戦略（レガシー互換）:
#      SAML_CERT_FETCH_STRATEGY=static
#      SAML_IDP_X509_CERT="..." (必須)
#      SAML_IDP_METADATA_URL="" (不要)
#      → 証明書更新時は手動で環境変数を更新
#
#    hybrid戦略（最大互換性）:
#      SAML_CERT_FETCH_STRATEGY=hybrid
#      SAML_IDP_X509_CERT="..." (第1候補)
#      SAML_IDP_METADATA_URL=http://localhost:8090/realms/koiki-saml/protocol/saml/descriptor
#      → 静的証明書で失敗時、自動的にメタデータから取得
#
# 4. 静的証明書の手動取得手順（static戦略の場合）:
#    - Admin Console > koiki-saml realm
#    - Realm Settings > Keys タブ
#    - RSA256の"Certificate"ボタンをクリック
#    - 表示された証明書をSAML_IDP_X509_CERTに設定
#
# 5. Docker内部通信が必要な場合:
#    SAML_IDP_ENTITY_ID=http://keycloak:8080/realms/koiki-saml
#    SAML_IDP_SSO_URL=http://keycloak:8080/realms/koiki-saml/protocol/saml
#    SAML_IDP_METADATA_URL=http://keycloak:8080/realms/koiki-saml/protocol/saml/descriptor
#
# 6. 証明書ローテーション対応:
#    auto/metadata/hybrid戦略では、IdPで証明書を更新しても自動的に追従します。
#    署名検証エラー時に自動的にメタデータから最新証明書を取得してリトライします。
