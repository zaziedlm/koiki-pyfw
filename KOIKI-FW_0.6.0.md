# KOIKI-FW v0.6.0 技術仕様書

## 概要

KOIKI-FW は Python (FastAPI) を用いたエンタープライズ向け Web アプリケーション構築のための堅牢な基盤フレームワークです。バージョン 0.6.0 では、認証系APIの充実とセキュリティ監査APIの強化に焦点を当てた設計となっています。また、バージョン 0.5.0 で実施された重要なセキュリティ脆弱性の修正と包括的な依存関係のモダナイゼーション、Python 3.13 対応、エンタープライズ向け依存性管理戦略を引き続き維持しています。

## v0.6.0 主要変更点

### 🔐 認証系API強化
- **認証APIの充実**: JWT認証、リフレッシュトークン、パスワードリセットなどの包括的な認証システム
- **セキュリティ監査API**: 認証セキュリティの強化とログイン試行制限の実装
- **ロールベースアクセス制御 (RBAC)**: より細かな権限管理機能
- **認証APIテスト**: 包括的なテストガイドとテスト実装

### 📖 ドキュメント強化
- **認証系API完全ガイド**: 認証システムの詳細な実装ガイド
- **セキュリティ強化対応記録**: セキュリティ改善の記録と対応履歴
- **APIテストガイド**: 認証システムのテスト方法とベストプラクティス

## v0.5.0 主要変更点（継承）

### 🚨 セキュリティアップデート
- **fastapi**: 0.104.1 → 0.115.13 (修正: PYSEC-2024-38)
- **python-jose**: 3.3.0 → 3.5.0 (修正: PYSEC-2024-232, PYSEC-2024-233)
- **starlette**: 0.27.0 → 0.46.2 (修正: GHSA-f96h-pmfr-66vw)

### 🔧 依存関係モダナイゼーション
- **Python 3.13 対応**: asyncpg 0.29.0 → 0.30.0 でコンパイルサポート強化
- **Enterprise Requirements**: pydantic 2.9.2 → 2.11.7 (>=2.7.0 要件対応)
- **Phase 1-3 Updates**: 低リスクから高リスクまで段階的な依存関係更新

### 📦 Poetry 2.x & PEP 621 対応
- **PEP 621 準拠**: プロジェクトメタデータと依存関係の標準化
- **依存関係グループ**: 開発、テスト、本番依存関係の明確な分離
- **パフォーマンス最適化**: 並列インストールと拡張キャッシュ管理

### 🔐 エンタープライズセキュリティ戦略
- **セキュリティ優先アプローチ**: 開発期間中の積極的なセキュリティ更新
- **監査ツール**: pip-audit, bandit による継続的セキュリティ監査
- **ゼロ脆弱性**: 既知の脆弱性完全解決

## アーキテクチャ

KOIKI-FW は、以下のような階層型アーキテクチャを採用しています:

1. **API レイヤー** (`api/`): エンドポイント定義、リクエスト/レスポンス処理、バリデーション
2. **サービスレイヤー** (`services/`): ビジネスロジック、トランザクション管理
3. **リポジトリレイヤー** (`repositories/`): データアクセスと永続化
4. **モデルレイヤー** (`models/`): データモデルとリレーションシップ
5. **スキーマレイヤー** (`schemas/`): Pydantic モデル、データ検証

各レイヤーは明確に分離され、依存性は上位レイヤーから下位レイヤーへの一方向のみとなっています。

## 主要コンポーネント

### コア機能

- **設定管理** (`core/config.py`): 環境変数ベースの設定管理
- **ロギング** (`core/logging.py`): structlog による構造化ロギング (v25.4.0)
- **エラー処理** (`core/error_handlers.py`): 一貫したエラーレスポンス
- **セキュリティ** (`core/security.py`): JWT認証、パスワードハッシュ化
- **トランザクション管理** (`core/transaction.py`): 非同期トランザクションデコレータ
- **ミドルウェア** (`core/middleware.py`): 監査ログ、セキュリティヘッダー等

### データベース

- **セッション管理** (`db/session.py`): 非同期DBセッション (asyncpg 0.30.0)
- **基底モデル** (`db/base.py`): SQLAlchemy 2.0+ モデルの共通機能
- **マイグレーション**: Alembic 1.16.2 でデータベース変更管理

### イベントシステム

- **パブリッシャー** (`events/publisher.py`): イベント発行機能
- **ハンドラー** (`events/handlers.py`): イベント処理ロジック
- **Redis統合**: Redis 6.2.0 でメッセージキューとキャッシュ

### 非同期タスク

- **Celery統合** (`tasks/celery_app.py`): 非同期タスク処理
- **メール送信** (`tasks/email.py`): メール送信タスク

## セキュリティ機能

### 認証・認可
- JWT ベースの認証 (python-jose 3.5.0)
- RBAC (ロールベースアクセス制御)
- パスワード複雑性チェック
- レートリミット (slowapi 0.1.8+)
- セキュリティヘッダー (HSTS, CSP, etc.)
- 監査ログ記録

### セキュリティ監査
- **pip-audit 2.9.0**: OSV データベースによる脆弱性スキャン
- **bandit 1.8.5**: 静的セキュリティ解析
- **継続的監査**: CI/CD パイプラインでの自動セキュリティチェック

## モニタリングと運用

- Prometheus メトリクス (prometheus-fastapi-instrumentator 7.1.0)
- 構造化ログ出力 (structlog 25.4.0)
- リクエスト ID 追跡
- パフォーマンス測定
- HTTP クライアント監視 (httpx 0.28.1)

## ToDo サンプルアプリケーション

フレームワークの使用例として、シンプルな ToDo アプリケーションが **libkoiki フレームワーク内** に実装されています。これには以下の機能が含まれます:

- ユーザー登録とログイン
- ToDo アイテムの作成、読取、更新、削除 (CRUD)
- 所有者によるアクセス制御

**重要**: v0.6.0では、ToDoアプリケーションはフレームワーク機能として`libkoiki/`内に実装されており、`app/`は拡張用の基盤を提供しています。

## モジュール構成

フレームワークは `libkoiki` パッケージとして提供され、アプリケーションは `app` ディレクトリに実装します。

**v0.6.0での実装状況:**
- **libkoiki/**: 認証、Todo、ユーザー管理などの主要機能を完全実装
- **app/**: 将来的なビジネス固有の拡張やカスタマイズ用の基盤を提供

この分離により:
1. フレームワークの機能を再利用可能なパッケージとして扱える
2. アプリケーション固有のコードとフレームワークコードを明確に分離できる
3. フレームワークを個別に更新・バージョン管理できる

### Poetry 2.x & PEP 621 最適化

- **PEP 621 メタデータ**: `[project]` セクションでの標準化された依存関係管理
- **依存関係グループ**: `--with dev,test,security` による柔軟なインストール
- **並列インストール**: `installer.parallel = true` でパフォーマンス向上
- **ビルドシステム**: poetry-core >=1.5.0 で最新機能対応

## 継続的インテグレーション (CI)

KOIKI-FW では、GitHub Actions を活用した継続的インテグレーション (CI) パイプラインを実装しています。このパイプラインにより、コードの品質と安定性を確保しています。

### CI パイプラインの構成

CI パイプラインは `.github/workflows/ci.yml` で定義され、以下のイベントで実行されます：

- **プッシュイベント**: `master`, `develop`, `dev/*`, `feature/*`, `bugfix/*` ブランチへのプッシュ
- **プルリクエスト**: `master`, `develop` ブランチへのプルリクエスト

### 実行環境

- **ランナー**: Ubuntu 最新版
- **サービス**: PostgreSQL 15（テスト用データベース）
- **Python バージョン**: 3.11.7+ (Python 3.13 対応)
- **Poetry**: 2.x 最適化

### CI プロセスの主要ステップ

1. **コードチェックアウト**: リポジトリからコードを取得
2. **Python 環境セットアップ**: 指定バージョンの Python をインストール
3. **Poetry インストール**: Poetry 2.x をセットアップ
4. **パッケージ整合性検証**: `pyproject.toml` と `poetry.lock` の整合性を確認
5. **依存関係インストール**: Poetry 2.x 並列インストールで高速化
6. **セキュリティ監査**: pip-audit, bandit による自動セキュリティチェック
7. **テスト実行**: Pytest によるテスト実行とカバレッジレポート生成（**注意**: `tests/unit/app/`のみを対象とし、アプリケーション開発チームのコードに焦点）
8. **カバレッジレポート保存**: HTML形式のカバレッジレポートをアーティファクトとして保存

### CI 環境の設定

テスト実行時には、以下の環境変数が設定されます：

- `DATABASE_URL`: テスト用 PostgreSQL データベースへの接続文字列
- `ENV_FILE`: CI 環境用の環境変数ファイル (`.env.ci`)

### CI の利点

- **早期問題検出**: コードの問題を早期に発見し、修正することが可能
- **品質保証**: 自動テストによりコードの品質を継続的に検証
- **セキュリティゲート**: 脆弱性検出時のデプロイメント阻止
- **開発効率向上**: 手動テストの負担を軽減し、開発者の生産性を向上
- **安定性確保**: マスターブランチのコード安定性を維持

## バージョン履歴

### v0.6.0 (2025-07-16)
- **認証系API充実**: JWT認証、リフレッシュトークン、パスワードリセット機能の包括的実装
- **セキュリティ監査API強化**: 認証セキュリティの強化とログイン試行制限の実装
- **ロールベースアクセス制御 (RBAC)**: 細かな権限管理機能の実装
- **認証APIテスト**: 包括的なテストガイドとテスト実装の提供
- **ドキュメント強化**: 認証系API完全ガイド、セキュリティ強化対応記録、APIテストガイドの追加
- **セキュリティ継承**: v0.5.0 のセキュリティ修正とゼロ脆弱性状態の維持

### v0.5.0 (2025-06-21)
- **重要セキュリティ修正**: fastapi, python-jose, starlette の脆弱性解決
- **包括的依存関係モダナイゼーション**: 51パッケージの最新化
- **Python 3.13 対応**: asyncpg, pydantic等の互換性確保
- **Poetry 2.x & PEP 621 対応**: エンタープライズ依存性管理戦略
- **セキュリティ監査強化**: pip-audit, bandit による継続的監査
- **ゼロ脆弱性達成**: 既知のセキュリティリスク完全解決

### v0.3.1
- GitHub Actions による継続的インテグレーション (CI) パイプラインの実装
- テスト自動化とカバレッジレポート生成の導入
- Poetry による依存関係管理の強化
- CI ワークフローのドキュメント整備

### v0.3.0
- モジュール構造の改善（libkoiki パッケージ化）
- 依存関係管理の最適化
- インポートパスの標準化
- ドキュメント整備

### v0.2.0
- ToDo サンプルアプリケーションの追加
- RBAC 実装の強化
- イベントシステムの改善
- トランザクション管理の最適化

### v0.1.0
- 初期リリース
- 基本的なフレームワーク構造
- 認証システム
- 非同期データベースアクセス

## エンタープライズ向け依存性管理戦略

### セキュリティ優先アプローチ
1. **即座の脆弱性対応**: 開発期間中の積極的なセキュリティ更新
2. **影響範囲分析**: 依存関係数と影響範囲に基づく更新判断
3. **企業要件遵守**: pydantic >=2.7.0 等のエンタープライズ要件維持
4. **段階的更新**: Phase 1-3 でリスクレベル別の計画的更新

### 監査・品質保証
- **継続的セキュリティ監査**: 日次 pip-audit スキャン
- **静的解析**: bandit による高深刻度問題検出
- **デプロイメントゲート**: 脆弱性検出時の本番リリース阻止
- **コンプライアンス**: JSON レポート生成による監査証跡確保