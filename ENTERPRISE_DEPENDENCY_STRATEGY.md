# エンタープライズ向け依存性管理戦略

## バージョン管理ポリシー

### 1. 本番環境（Production）
- **固定バージョン**: 完全に固定された具体的バージョン
- **例**: `fastapi==0.104.1`
- **理由**: 100%の再現性、予期しない変更の回避

### 2. 開発環境（Development）
- **マイナーバージョン固定**: パッチレベルのみ許可
- **例**: `fastapi>=0.104.1,<0.105.0`
- **理由**: セキュリティパッチ適用、機能変更リスク最小化

### 3. テスト環境（Testing）
- **パッチレベル範囲**: セキュリティ修正のみ許可
- **例**: `fastapi>=0.104.1,<0.104.10`
- **理由**: セキュリティ対応とテスト安定性の両立

## 推奨バージョン範囲パターン

### セキュリティ重視（推奨）
```toml
dependencies = [
    "fastapi==0.104.1",                    # 完全固定
    "uvicorn==0.24.0",                     # 完全固定
    "sqlalchemy[asyncio]==2.0.23",        # 完全固定
    "asyncpg==0.29.0",                     # 完全固定
    "alembic==1.12.1",                     # 完全固定
    "pydantic==2.5.0",                     # 完全固定
    "pydantic-settings==2.9.1",           # 完全固定
]
```

### バランス型（中間）
```toml
dependencies = [
    "fastapi>=0.104.1,<0.105.0",          # マイナー固定
    "uvicorn>=0.24.0,<0.25.0",            # マイナー固定
    "sqlalchemy[asyncio]>=2.0.23,<2.1.0", # マイナー固定
    "asyncpg>=0.29.0,<0.30.0",            # マイナー固定
    "alembic>=1.12.1,<1.13.0",            # マイナー固定
]
```

### 開発柔軟型（非推奨）
```toml
dependencies = [
    "fastapi>=0.104.1,<1.0.0",            # 現在の設定
    "uvicorn>=0.24.0,<1.0.0",             # リスク高
]
```

## セキュリティ監査プロセス

### 1. 定期的な脆弱性スキャン
```bash
# Poetry audit plugin
poetry self add poetry-audit-plugin
poetry audit

# Safety による脆弱性チェック
poetry add --group dev safety
poetry run safety check

# pip-audit による詳細チェック
poetry add --group dev pip-audit
poetry run pip-audit
```

### 2. 依存性更新戦略
```bash
# 1. 現在の依存性確認
poetry show --outdated

# 2. セキュリティアップデート優先
poetry update --dry-run

# 3. 段階的更新（本番前にテスト環境で検証）
poetry add "fastapi==0.104.2"  # 特定バージョンに更新
poetry lock
poetry install
```

### 3. 継続的監視
- **月次**: 依存性脆弱性スキャン
- **週次**: アップデート可能パッケージ確認
- **即座**: Critical CVE 対応

## 運用ガイドライン

### バージョン更新プロセス
1. **脆弱性発見** → CVE番号確認
2. **影響評価** → 該当バージョン範囲確認
3. **テスト環境更新** → 動作確認
4. **ステージング環境更新** → 統合テスト
5. **本番環境更新** → 段階的デプロイ

### 緊急セキュリティ対応
```bash
# 緊急パッチ適用例
poetry add "fastapi==0.104.2"  # セキュリティ修正版
poetry lock --no-update         # 他依存性は固定
docker-compose build --no-cache
```

## リスク評価マトリックス

| バージョン指定方法 | 再現性 | セキュリティ | 保守性 | 推奨度 |
|------------------|-------|------------|-------|--------|
| 完全固定 (==)     | ★★★   | ★★☆        | ★☆☆   | ★★★    |
| マイナー固定 (~=) | ★★☆   | ★★★        | ★★☆   | ★★★    |
| 範囲指定 (>=,<)   | ★☆☆   | ★☆☆        | ★★★   | ★☆☆    |

## 実装推奨案

企業環境では「完全固定」または「マイナー固定」を強く推奨します。