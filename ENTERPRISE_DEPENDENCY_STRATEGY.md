# エンタープライズ向け依存性管理戦略

## バージョン管理ポリシー

### 1. 本番環境（Production）
- **固定バージョン**: 完全に固定された具体的バージョン
- **例**: `fastapi==0.104.1`
- **理由**: 100%の再現性、予期しない変更の回避

### 2. 開発環境（Development）
- **マイナーバージョン固定**: パッチレベルのみ許可
- **例**: `fastapi>=0.104.1,<0.105.0`
- **理由**: セキュリティパッチ適用、機能変更リスク最小化

### 3. テスト環境（Testing）
- **パッチレベル範囲**: セキュリティ修正のみ許可
- **例**: `fastapi>=0.104.1,<0.104.10`
- **理由**: セキュリティ対応とテスト安定性の両立

## 推奨バージョン範囲パターン

### セキュリティ重視（推奨）
```toml
dependencies = [
    "fastapi==0.104.1",                    # 完全固定
    "uvicorn==0.24.0",                     # 完全固定
    "sqlalchemy[asyncio]==2.0.23",        # 完全固定
    "asyncpg==0.29.0",                     # 完全固定
    "alembic==1.12.1",                     # 完全固定
    "pydantic==2.5.0",                     # 完全固定
    "pydantic-settings==2.9.1",           # 完全固定
]
```

### バランス型（中間）
```toml
dependencies = [
    "fastapi>=0.104.1,<0.105.0",          # マイナー固定
    "uvicorn>=0.24.0,<0.25.0",            # マイナー固定
    "sqlalchemy[asyncio]>=2.0.23,<2.1.0", # マイナー固定
    "asyncpg>=0.29.0,<0.30.0",            # マイナー固定
    "alembic>=1.12.1,<1.13.0",            # マイナー固定
]
```

### 開発柔軟型（非推奨）
```toml
dependencies = [
    "fastapi>=0.104.1,<1.0.0",            # 現在の設定
    "uvicorn>=0.24.0,<1.0.0",             # リスク高
]
```

## セキュリティ監査プロセス

### 1. 定期的な脆弱性スキャン
```bash
# Poetry audit plugin
poetry self add poetry-audit-plugin
poetry audit

# Safety による脆弱性チェック
poetry add --group dev safety
poetry run safety check

# pip-audit による詳細チェック
poetry add --group dev pip-audit
poetry run pip-audit
```

### 2. 依存性更新戦略
```bash
# 1. 現在の依存性確認
poetry show --outdated

# 2. セキュリティアップデート優先
poetry update --dry-run

# 3. 段階的更新（本番前にテスト環境で検証）
poetry add "fastapi==0.104.2"  # 特定バージョンに更新
poetry lock
poetry install
```

### 3. 継続的監視
- **月次**: 依存性脆弱性スキャン
- **週次**: アップデート可能パッケージ確認
- **即座**: Critical CVE 対応

## 運用ガイドライン

### バージョン更新プロセス
1. **脆弱性発見** → CVE番号確認
2. **影響評価** → 該当バージョン範囲確認
3. **テスト環境更新** → 動作確認
4. **ステージング環境更新** → 統合テスト
5. **本番環境更新** → 段階的デプロイ

### 緊急セキュリティ対応
```bash
# 緊急パッチ適用例
poetry add "fastapi==0.104.2"  # セキュリティ修正版
poetry lock --no-update         # 他依存性は固定
docker-compose build --no-cache
```

## リスク評価マトリックス

| バージョン指定方法 | 再現性 | セキュリティ | 保守性 | 推奨度 |
|------------------|-------|------------|-------|--------|
| 完全固定 (==)     | ★★★   | ★★☆        | ★☆☆   | ★★★    |
| マイナー固定 (~=) | ★★☆   | ★★★        | ★★☆   | ★★★    |
| 範囲指定 (>=,<)   | ★☆☆   | ★☆☆        | ★★★   | ★☆☆    |

## 実装推奨案

企業環境では「完全固定」または「マイナー固定」を強く推奨します。

## 実装結果報告 (2025-06-21)

### 成功事例: セキュリティ優先アプローチの実践

**実施方針**: 開発期間中のセキュリティ優先アプローチ

**背景**: 
- pydantic >=2.7.0 要件
- Python 3.13 互換性要求
- 既知の脆弱性修正 (PYSEC-2024-38, PYSEC-2024-232/233, GHSA-f96h-pmfr-66vw)

**実施した更新戦略**:

### Phase 1: 低リスク (4パッケージ)
```toml
# 実装例 - 安全な更新
"email-validator>=2.2.0,<2.3.0"     # 2.1.2 → 2.2.0
"pytest-cov>=6.2.1,<6.3.0"         # 6.1.1 → 6.2.1
```
**結果**: ✅ 問題なし、即座実施可能

### Phase 2: 中リスク (6パッケージ) 
```toml
# 実装例 - 慎重な段階的更新
"pydantic>=2.11.7,<2.12.0"         # 2.9.2 → 2.11.7
"httpx>=0.28.1,<0.29.0"            # 0.25.2 → 0.28.1
"structlog>=25.4.0,<25.5.0"        # 23.2.0 → 25.4.0
"alembic>=1.16.2,<1.17.0"          # 1.12.1 → 1.16.2
```
**結果**: ✅ 全テスト通過、1パッケージずつ段階実施

### Phase 3: 高リスク (5パッケージ)
```toml
# 実装例 - 詳細検証後の大幅更新
"uvicorn>=0.34.3,<0.35.0"          # 0.24.0 → 0.34.3 (メジャー改善)
"pytest>=8.4.1,<8.5.0"             # 7.4.4 → 8.4.1 (メジャーアップ)
"redis>=6.2.0,<6.3.0"              # 5.0.8 → 6.2.0 (メジャーアップ)
```
**結果**: ✅ 破壊的変更なし、大幅なパフォーマンス向上

### 学習ポイント

**成功要因**:
1. **開発期間活用**: 本番影響のない期間での積極的更新
2. **段階的実施**: リスクレベル別の順次更新
3. **包括的テスト**: 各段階での動作確認
4. **コンテナ検証**: 本番環境同等での最終確認

**企業環境への提言**:
- 開発期間 = マイナーバージョン固定の緩和期間として活用
- セキュリティ修正 > バージョン安定性 (開発期間限定)
- 段階的アプローチによるリスク最小化
- 包括的な自動テストによる品質保証

**最終結果**: 
- ✅ 脆弱性ゼロ達成
- ✅ Python 3.13 完全対応
- ✅ パフォーマンス大幅向上
- ✅ 本番デプロイ準備完了