# docker-compose.base.yml
# 全環境共通のベース設定
# このファイルは直接使用せず、環境別composeファイルから参照されます

x-app-base: &app-base
  build:
    context: .
    dockerfile: Dockerfile.unified
  env_file:
    - ${ENV_FILE:-.env}
  depends_on:
    db:
      condition: service_healthy
    keycloak:
      condition: service_started
  ports:
    - "${APP_PORT:-8000}:8000"
  restart: ${RESTART_POLICY:-unless-stopped}

x-frontend-base: &frontend-base
  build:
    context: ./frontend
    dockerfile: Dockerfile.unified
  depends_on:
    - app
  ports:
    - "${FRONTEND_PORT:-3000}:3000"
  restart: ${RESTART_POLICY:-unless-stopped}

services:
  db:
    image: postgres:15
    env_file:
      - ${ENV_FILE:-.env}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-koiki_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-koiki_password}
      POSTGRES_DB: ${POSTGRES_DB:-koiki_todo_db}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}" ]
      interval: ${DB_HEALTHCHECK_INTERVAL:-10s}
      timeout: ${DB_HEALTHCHECK_TIMEOUT:-5s}
      retries: ${DB_HEALTHCHECK_RETRIES:-5}
    restart: ${RESTART_POLICY:-unless-stopped}

  keycloak:
    image: quay.io/keycloak/keycloak:26.3.5
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=${KEYCLOAK_ADMIN:-admin}
      - KC_BOOTSTRAP_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
    volumes:
      - ./docker/keycloak/realm-koiki.json:/opt/keycloak/data/import/realm-koiki.json:ro
      - ./docker/keycloak/realm-saml.json:/opt/keycloak/data/import/realm-saml.json:ro
    healthcheck:
      test: [ "CMD-SHELL", "exec 3<>/dev/tcp/localhost/9000 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'" ]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: ${RESTART_POLICY:-unless-stopped}

networks:
  default:
    name: ${COMPOSE_PROJECT_NAME:-koiki-pyfw}_network
    driver: bridge
