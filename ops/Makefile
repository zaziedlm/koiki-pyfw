# KOIKI-FW ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆç”¨ Makefile (å»ƒæ­¢äºˆå®š)
# 
# æ³¨æ„: ã“ã®Makefileã¯å»ƒæ­¢äºˆå®šã§ã™
# Windowsç’°å¢ƒã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š
#
# æ¨å¥¨æ–¹æ³•:
#   ./ops/scripts/run_tests.sh <command>    # ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ
#
# ç’°å¢ƒåˆ¥:
#   ./ops/scripts/security_test_manager.sh  # Unixç³» (Bash)
#   ./ops/scripts/security_test_manager.ps1 # Windows (PowerShell)

.PHONY: help setup test clean reset logs migration-notice

migration-notice: ## ç§»è¡Œæ¡ˆå†…ã‚’è¡¨ç¤º
	@echo "âš ï¸  Makefileã¯å»ƒæ­¢äºˆå®šã§ã™"
	@echo "Windowsç’°å¢ƒã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š"
	@echo ""
	@echo "æ¨å¥¨æ–¹æ³•ï¼ˆå…¨ç’°å¢ƒï¼‰:"
	@echo "  ./ops/scripts/run_tests.sh setup    # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
	@echo "  ./ops/scripts/run_tests.sh test     # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo "  ./ops/scripts/run_tests.sh help     # ãƒ˜ãƒ«ãƒ—"
	@echo ""
	@echo "ç’°å¢ƒåˆ¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆ:"
	@echo "  ./ops/scripts/security_test_manager.sh   # Unixç³»"
	@echo "  ./ops/scripts/security_test_manager.ps1  # Windows"

help: migration-notice ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤ºï¼ˆç§»è¡Œæ¡ˆå†…ä»˜ãï¼‰
	@echo "KOIKI-FW ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒãƒ³ãƒ‰"
	@echo "=================================="
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

setup: migration-notice ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆéæ¨å¥¨ï¼‰
	@echo "âš ï¸  æ¨å¥¨: ./ops/scripts/run_tests.sh setup"
	@echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹..."
	docker-compose up -d
	@sleep 5
	docker-compose exec app python ops/scripts/setup_security.py

test: migration-notice ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£APIãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆéæ¨å¥¨ï¼‰
	@echo "âš ï¸  æ¨å¥¨: ./ops/scripts/run_tests.sh test"
	@echo "ğŸ§ª ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£APIãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	docker-compose exec app python ops/tests/test_security_api.py

test-full: migration-notice ## çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆéæ¨å¥¨ï¼‰
	@echo "âš ï¸  æ¨å¥¨: ./ops/scripts/run_tests.sh test-full"
	@echo "ğŸ”„ çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./ops/scripts/run_security_test.sh

clean: migration-notice ## ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ï¼ˆéæ¨å¥¨ï¼‰
	@echo "âš ï¸  æ¨å¥¨: ./ops/scripts/run_tests.sh clean"
	@echo "ğŸ§¹ ç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."
	docker-compose down

reset: migration-notice ## å®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼‰ï¼ˆéæ¨å¥¨ï¼‰
	@echo "âš ï¸  æ¨å¥¨: ./ops/scripts/run_tests.sh reset"
	@echo "ğŸ”„ å®Œå…¨ãƒªã‚»ãƒƒãƒˆ..."
	docker-compose down -v
	docker-compose up --build -d
	@sleep 10
	docker-compose exec app python ops/scripts/setup_security.py

logs: migration-notice ## ãƒ­ã‚°ç¢ºèªï¼ˆéæ¨å¥¨ï¼‰
	@echo "âš ï¸  æ¨å¥¨: ./ops/scripts/run_tests.sh logs"
	docker-compose logs -f app

db-check: migration-notice ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…å®¹ç¢ºèªï¼ˆéæ¨å¥¨ï¼‰
	@echo "âš ï¸  æ¨å¥¨: ./ops/scripts/run_tests.sh db-check"
	@echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…å®¹ç¢ºèª..."
	@echo "æ¨©é™ä¸€è¦§:"
	@docker-compose exec -T db psql -U koiki_user -d koiki_todo_db -c "SELECT name, resource, action FROM permissions ORDER BY resource, action;" 2>/dev/null || true
	@echo ""
	@echo "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«:"
	@docker-compose exec -T db psql -U koiki_user -d koiki_todo_db -c "SELECT u.email, r.name FROM users u JOIN user_roles ur ON u.id = ur.user_id JOIN roles r ON r.id = ur.role_id ORDER BY u.email;" 2>/dev/null || true

manual-test: migration-notice ## æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨æƒ…å ±è¡¨ç¤ºï¼ˆéæ¨å¥¨ï¼‰
	@echo "âš ï¸  æ¨å¥¨: ./ops/scripts/run_tests.sh manual-test"
	@echo "ğŸ”‘ æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒãƒ³ãƒ‰"
	@echo "======================"
	@echo ""
	@echo "1. ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³:"
	@echo "curl -X POST http://localhost:8000/api/v1/auth/login \\"
	@echo "  -H \"Content-Type: application/json\" \\"
	@echo "  -d '{\"username\": \"admin\", \"password\": \"admin123456\"}'"
	@echo ""
	@echo "2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—:"
	@echo "curl -H \"Authorization: Bearer <TOKEN>\" \\"
	@echo "     http://localhost:8000/security/metrics"
	@echo ""
	@echo "3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—:"
	@echo "curl -H \"Authorization: Bearer <TOKEN>\" \\"
	@echo "     http://localhost:8000/api/v1/users"
