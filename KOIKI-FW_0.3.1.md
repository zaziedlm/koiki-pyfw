# KOIKI-FW v0.3.1 技術仕様書

## 概要

KOIKI-FW は Python (FastAPI) を用いたエンタープライズ向け Web アプリケーション構築のための堅牢な基盤フレームワークです。バージョン 0.3.1 では、モジュール性、セキュリティ、パフォーマンスに加え、継続的インテグレーション(CI)による品質保証の強化に焦点を当てた設計となっています。

## アーキテクチャ

KOIKI-FW は、以下のような階層型アーキテクチャを採用しています:

1. **API レイヤー** (`api/`): エンドポイント定義、リクエスト/レスポンス処理、バリデーション
2. **サービスレイヤー** (`services/`): ビジネスロジック、トランザクション管理
3. **リポジトリレイヤー** (`repositories/`): データアクセスと永続化
4. **モデルレイヤー** (`models/`): データモデルとリレーションシップ
5. **スキーマレイヤー** (`schemas/`): Pydantic モデル、データ検証

各レイヤーは明確に分離され、依存性は上位レイヤーから下位レイヤーへの一方向のみとなっています。

## 主要コンポーネント

### コア機能

- **設定管理** (`core/config.py`): 環境変数ベースの設定管理
- **ロギング** (`core/logging.py`): structlog による構造化ロギング
- **エラー処理** (`core/error_handlers.py`): 一貫したエラーレスポンス
- **セキュリティ** (`core/security.py`): JWT認証、パスワードハッシュ化
- **トランザクション管理** (`core/transaction.py`): 非同期トランザクションデコレータ
- **ミドルウェア** (`core/middleware.py`): 監査ログ、セキュリティヘッダー等

### データベース

- **セッション管理** (`db/session.py`): 非同期DBセッション
- **基底モデル** (`db/base.py`): SQLAlchemy モデルの共通機能

### イベントシステム

- **パブリッシャー** (`events/publisher.py`): イベント発行機能
- **ハンドラー** (`events/handlers.py`): イベント処理ロジック

### 非同期タスク

- **Celery統合** (`tasks/celery_app.py`): 非同期タスク処理
- **メール送信** (`tasks/email.py`): メール送信タスク

## セキュリティ機能

- JWT ベースの認証
- RBAC (ロールベースアクセス制御)
- パスワード複雑性チェック
- レートリミット
- セキュリティヘッダー (HSTS, CSP, etc.)
- 監査ログ記録

## モニタリングと運用

- Prometheus メトリクス
- 構造化ログ出力
- リクエスト ID 追跡
- パフォーマンス測定

## ToDo サンプルアプリケーション

フレームワークの使用例として、シンプルな ToDo アプリケーションが実装されています。これには以下の機能が含まれます:

- ユーザー登録とログイン
- ToDo アイテムの作成、読取、更新、削除 (CRUD)
- 所有者によるアクセス制御

## モジュール構成

フレームワークは `libkoiki` パッケージとして提供され、アプリケーションは `app` ディレクトリに実装します。この分離により:

1. フレームワークの機能を再利用可能なパッケージとして扱える
2. アプリケーション固有のコードとフレームワークコードを明確に分離できる
3. フレームワークを個別に更新・バージョン管理できる

## 継続的インテグレーション (CI)

KOIKI-FW では、GitHub Actions を活用した継続的インテグレーション (CI) パイプラインを実装しています。このパイプラインにより、コードの品質と安定性を確保しています。

### CI パイプラインの構成

CI パイプラインは `.github/workflows/ci.yml` で定義され、以下のイベントで実行されます：

- **プッシュイベント**: `master`, `develop`, `dev/*`, `feature/*`, `bugfix/*` ブランチへのプッシュ
- **プルリクエスト**: `master`, `develop` ブランチへのプルリクエスト

### 実行環境

- **ランナー**: Ubuntu 最新版
- **サービス**: PostgreSQL 15（テスト用データベース）
- **Python バージョン**: 3.11.7（フレームワークの推奨バージョン）

### CI プロセスの主要ステップ

1. **コードチェックアウト**: リポジトリからコードを取得
2. **Python 環境セットアップ**: 指定バージョンの Python をインストール
3. **Poetry インストール**: 依存関係管理ツール Poetry をセットアップ
4. **パッケージ整合性検証**: `pyproject.toml` と `poetry.lock` の整合性を確認
5. **依存関係インストール**: Poetry を使用してプロジェクト依存関係をインストール
6. **テスト実行**: Pytest によるテスト実行とカバレッジレポート生成
7. **カバレッジレポート保存**: HTML形式のカバレッジレポートをアーティファクトとして保存

### CI 環境の設定

テスト実行時には、以下の環境変数が設定されます：

- `DATABASE_URL`: テスト用 PostgreSQL データベースへの接続文字列
- `ENV_FILE`: CI 環境用の環境変数ファイル (`.env.ci`)

### CI の利点

- **早期問題検出**: コードの問題を早期に発見し、修正することが可能
- **品質保証**: 自動テストによりコードの品質を継続的に検証
- **開発効率向上**: 手動テストの負担を軽減し、開発者の生産性を向上
- **安定性確保**: マスターブランチのコード安定性を維持

## バージョン履歴

### v0.3.1
- GitHub Actions による継続的インテグレーション (CI) パイプラインの実装
- テスト自動化とカバレッジレポート生成の導入
- Poetry による依存関係管理の強化
- CI ワークフローのドキュメント整備

### v0.3.0
- モジュール構造の改善（libkoiki パッケージ化）
- 依存関係管理の最適化
- インポートパスの標準化
- ドキュメント整備

### v0.2.0
- ToDo サンプルアプリケーションの追加
- RBAC 実装の強化
- イベントシステムの改善
- トランザクション管理の最適化

### v0.1.0
- 初期リリース
- 基本的なフレームワーク構造
- 認証システム
- 非同期データベースアクセス
